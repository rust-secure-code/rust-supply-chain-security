<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Build for production - Rust Supply Chain Security Guide</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="A guide to securing the software supply chain of Rust programs and libraries">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="dependencies.html"><strong aria-hidden="true">1.</strong> Manage dependencies</a></li><li class="chapter-item expanded "><a href="maintain.html"><strong aria-hidden="true">2.</strong> Maintain a crate</a></li><li class="chapter-item expanded "><a href="build.html" class="active"><strong aria-hidden="true">3.</strong> Build for production</a></li><li class="chapter-item expanded "><a href="run.html"><strong aria-hidden="true">4.</strong> Run in production</a></li><li class="chapter-item expanded affix "><a href="checklist.html">Checklist</a></li><li class="chapter-item expanded affix "><a href="links.html">External links</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust Supply Chain Security Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-secure-code/rust-supply-chain-security" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-secure-code/rust-supply-chain-security/edit/main/src/build.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="build-for-production"><a class="header" href="#build-for-production">Build for production</a></h1>
<p>The build step is sometimes overlooked when it comes to software security, but is critical,
as recent events like the <a href="https://www.crowdstrike.com/blog/sunspot-malware-technical-analysis/">SUNSPOT attack</a> on SolarWinds build platform
showed.
Attacks can consist in tricking the build system into building from modified sources 
or inserting malicious software in the build environment.</p>
<p>Another important aspect is to allow users to get visibility over how the program was built,
for example, by providing a precise list of included components, and ideally to allow the users
the check that the produced artifacts actually match this information.</p>
<h2 id="build-process"><a class="header" href="#build-process">Build process</a></h2>
<h3 id="BUILD-TOOLCHAIN"><a class="header" href="#BUILD-TOOLCHAIN">Build toolchain (BUILD-TOOLCHAIN)</a></h3>
<p><code>rustup</code> is a very convenient tool for managing Rust toolchains, but <a href="https://rust-lang.github.io/rustup/security.html">does not yet</a> validate
signatures for the downloaded files. Depending on your requirements, it may be preferable to choose another installation method like
<a href="https://forge.rust-lang.org/infra/other-installation-methods.html#standalone-installers">standalone installers</a>
which allow you to validate signatures for downloaded files (or a Rust compiler provided by your Linux distribution).</p>
<h3 id="BUILD-LOCKED"><a class="header" href="#BUILD-LOCKED">Locked dependencies (BUILD-LOCKED)</a></h3>
<p>When building for production, you should have a <code>Cargo.lock</code> file in the sources,
and ensure the build commands include the <code>--locked</code> flag.</p>
<p>This ensures dependencies' integrity (at least compared to when the lock file was committed), as
the <code>Cargo.lock</code> file contains a hash for each crate source, that is checked at build.
It also ensures the dependencies used for production build match what the source repository contains
(git tag, etc.).
If there is an inconsistency between the <code>Cargo.lock</code>
and <code>Cargo.toml</code> and the <code>--locked</code> flag is passed the build will fail
(while the lock file would be automatically updated without it).</p>
<h3 id="BUILD-REPRODUCIBLE"><a class="header" href="#BUILD-REPRODUCIBLE">Reproducible builds (BUILD-REPRODUCIBLE)</a></h3>
<p><a href="https://reproducible-builds.org/">Reproducible builds</a> designates an effort to make
software re-buildable from sources with the exact same output, allowing anyone to check 
that the provided binaries are actually the product of their sources.
This requires the build process to be deterministic.</p>
<p>It is currently possible to make reproducible builds in Rust, but it requires
some actions to remove build-time absolute paths from the binaries
(which are used in debug and panic messages).
This also leaks the absolute path of the files on the build system which may not be desirable.
To remove them, you need to pass the
<a href="https://doc.rust-lang.org/rustc/command-line-arguments.html#--remap-path-prefix-remap-source-names-in-output"><code>--remap-path-prefix</code></a>
option to <code>rustc</code>.
When using <code>cargo</code>, you can use the <code>RUSTFLAGS</code> environment variable, with something like:</p>
<pre><code class="language-shell">RUSTFLAGS=&quot;--remap-path-prefix /path/to/build=/static-placeholder&quot; cargo build --release
</code></pre>
<p>Or use a <a href="https://doc.rust-lang.org/cargo/reference/config.html"><code>config.toml</code> file for cargo</a> with:</p>
<pre><code class="language-toml">[build]
rustflags = [&quot;--remap-path-prefix /path/to/build=/static-placeholder&quot;]
</code></pre>
<p>You can pass the option multiple times (and, when multiple re-mappings are given and several
of them match, the last matching one is applied).
This process will become more straightforward once the <a href="https://rust-lang.github.io/rfcs/3127-trim-paths.html">RFC 3127</a>
gets <a href="https://github.com/rust-lang/cargo/issues/12137">implemented</a> in cargo.</p>
<h3 id="BUILD-ISOLATED"><a class="header" href="#BUILD-ISOLATED">Sandboxed builds (BUILD-ISOLATED)</a></h3>
<p>As building Rust code runs arbitrary code locally (procedural macros and <code>build.rs</code>),
the build environment should be protected against attacks that could lead to persisting malicious software in
the build environment.
To do so, the build environment should be ephemeral and isolated (in a dedicated container, or -even better- a VM).</p>
<h2 id="BUILD-AUDITABLE"><a class="header" href="#BUILD-AUDITABLE">Embed dependency list in binaries (BUILD-AUDITABLE)</a></h2>
<p>For traceability, it is useful to be able to get the list of dependencies from a build binary.
This allows, for example, auditing for known vulnerability directly on the binary files.
This is not done by default in Rust builds,
but you can use <a href="https://github.com/rust-secure-code/cargo-auditable"><code>cargo auditable</code></a> to include this information.</p>
<pre><code class="language-shell">cargo auditable build --release
</code></pre>
<p>You can then see the embedded data with <a href="https://github.com/rust-secure-code/cargo-auditable/tree/master/rust-audit-info"><code>rust-audit-info</code></a>:</p>
<pre><code class="language-shell">$ rust-audit-info my_program | jq
{
  &quot;packages&quot;: [
    {
      &quot;name&quot;: &quot;aho-corasick&quot;,
      &quot;version&quot;: &quot;0.7.20&quot;,
      &quot;source&quot;: &quot;registry&quot;,
      &quot;dependencies&quot;: [
        83
      ],
      &quot;features&quot;: [
        &quot;default&quot;,
        &quot;std&quot;
      ]
    }
    # [...]
}
</code></pre>
<p><strong>Warning</strong>: Due to <a href="https://internals.rust-lang.org/t/statically-linked-c-c-libraries/17175">the way some <code>-sys</code> crate work</a>, some C/C++ native
library may be included in the binary but not visible in the embedded data.</p>
<h2 id="BUILD-SIGN"><a class="header" href="#BUILD-SIGN">Signature (BUILD-SIGN)</a></h2>
<p>There is no specific tooling for signing Rust binaires at the moment, but common approaches can apply
You can, for example, use a GPG-based signature.</p>
<p>There is also an open <a href="https://github.com/trustification/rust-rfcs/blob/sigstore-rfc/text/0000-sigstore-integration.md">pre-RFC</a>
proposing to use <a href="https://www.sigstore.dev/">sigstore</a> for signing and verifying crates (<a href="https://internals.rust-lang.org/t/pre-rfc-using-sigstore-for-signing-and-verifying-crates/18115/31">topic on IRLO</a>).</p>
<h2 id="BUILD-SBOM"><a class="header" href="#BUILD-SBOM">Software Bill Of Materials (a.k.a. SBOM) (BUILD-SBOM)</a></h2>
<p><a href="https://www.aquasec.com/cloud-native-academy/supply-chain-security/sbom/">Software Bills Of Materials</a> for Rust programs usually need
to be created from the sources (as the binaries don't contain enough information).</p>
<p><strong>Warning</strong>: Due to <a href="https://internals.rust-lang.org/t/statically-linked-c-c-libraries/17175">the way some <code>-sys</code> crate work</a>, some C/C++ native
library may be included in the binary but not visible in the
SBOM.</p>
<p>There are available tooling for the two most common SBOM formats in the open-source ecosystems,
<a href="https://spdx.dev/">SPDX</a> and <a href="https://cyclonedx.org/">CycloneDX</a>.
Choosing a SBOM format is up to you (they should be somehow interoperable).</p>
<h3 id="cyclonedx-with-cargo-cyclonedx"><a class="header" href="#cyclonedx-with-cargo-cyclonedx">CycloneDX with <code>cargo-cyclonedx</code></a></h3>
<p>There is an official CycloneDX cargo subcommand to generate a SBOM
from a Rust project source, <a href="https://crates.io/crates/cargo-cyclonedx"><code>cargo-cyclonedx</code></a></p>
<pre><code class="language-bash"># Produced a `bom.cdx.json` files
cargo cyclonedx --all --format json --output-cdx
</code></pre>
<p>It understands cargo workspaces and produces a JSON (or XML) file in the current directory.
To aggregate several files, validate or sign them, you can use the <a href="https://github.com/CycloneDX/cyclonedx-cli"><code>cyclonedx-cli</code></a>.</p>
<pre><code class="language-bash">cyclonedx merge --input-files *.json --output-file myprogram.cdx.json
</code></pre>
<h3 id="spdx-and-cyclonedx-with-cargo-sbom"><a class="header" href="#spdx-and-cyclonedx-with-cargo-sbom">SPDX and CycloneDX with <code>cargo-sbom</code></a></h3>
<p>There is a cargo subcommand available to generate an SPDX or CycloneDX SBOM from a Rust project source,
<a href="https://github.com/psastras/sbom-rs"><code>cargo-sbom</code></a>.</p>
<pre><code class="language-bash"># SPDX output (default)
cargo sbom &gt; sbom.spdx.json
# CycloneDX output
cargo sbom --output-format cyclone_dx_json_1_4 &gt; sbom.cdx.json
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="maintain.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="run.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="maintain.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="run.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
